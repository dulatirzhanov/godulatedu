<!DOCTYPE html>
<html lang="ru">
<head>
  <meta http-equiv="refresh" content="0; url=https://dulatedu.com">
  <title>Redirecting...</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P430YKCERB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P430YKCERB');
</script>

</head>
<body>
  <main class="app-wrapper">
    <header>
      <h1>Генератор UTM-ссылок</h1>
      <p>Соберите промо-ссылку с нужными UTM-метками за секунды — просто заполните поля ниже.</p>
    </header>

    <section class="card">
      <form id="utm-form" autocomplete="off">
        <div class="field">
          <label for="base-url">Целевая ссылка</label>
          <input type="url" id="base-url" name="base-url" placeholder="https://example.com/landing" required />
          <p class="note">Укажите полный адрес страницы, на которую вы хотите вести трафик.</p>
          <p class="error" id="base-url-error">Похоже, ссылка некорректна. Проверьте, что она начинается с http:// или https://</p>
        </div>

        <div class="grid-two-columns">
          <div class="field">
            <label for="utm-source">UTM Source</label>
            <input type="text" id="utm-source" name="utm-source" placeholder="facebook" />
          </div>
          <div class="field">
            <label for="utm-medium">UTM Medium</label>
            <input type="text" id="utm-medium" name="utm-medium" placeholder="cpc" />
          </div>
        </div>

        <div class="grid-two-columns">
          <div class="field">
            <label for="utm-campaign">UTM Campaign</label>
            <input type="text" id="utm-campaign" name="utm-campaign" placeholder="black_friday" />
          </div>
          <div class="field">
            <label for="utm-term">UTM Term</label>
            <input type="text" id="utm-term" name="utm-term" placeholder="ключевое_слово" />
          </div>
        </div>

        <div class="field">
          <label for="utm-content">UTM Content</label>
          <input type="text" id="utm-content" name="utm-content" placeholder="вариант_баннера" />
        </div>

        <fieldset class="custom-params">
          <legend>Дополнительные параметры</legend>
          <div id="custom-params-container"></div>
          <button type="button" class="secondary" id="add-param">Добавить параметр</button>
        </fieldset>

        <div class="actions">
          <button type="button" class="secondary" id="reset-form">Очистить</button>
          <button type="submit" class="primary">Сгенерировать</button>
        </div>
      </form>
    </section>

    <section class="card output-card">
      <div class="field">
        <label for="result-url">Результирующая ссылка</label>
        <textarea id="result-url" readonly placeholder="Сгенерированная UTM-ссылка появится здесь"></textarea>
      </div>
      <div class="actions" style="justify-content: space-between;">
        <p class="note">Скопируйте готовую ссылку и используйте её в своих рекламных материалах.</p>
        <button type="button" class="primary" id="copy-link">Скопировать ссылку</button>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById('utm-form');
    const resultTextarea = document.getElementById('result-url');
    const baseUrlInput = document.getElementById('base-url');
    const baseUrlError = document.getElementById('base-url-error');
    const addParamButton = document.getElementById('add-param');
    const customParamsContainer = document.getElementById('custom-params-container');
    const resetButton = document.getElementById('reset-form');
    const copyButton = document.getElementById('copy-link');

    const slugify = (value) => value
      .trim()
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9-_]+/g, '_')
      .replace(/_+/g, '_')
      .replace(/^_|_$/g, '');

    const createCustomRow = (name = '', value = '') => {
      const row = document.createElement('div');
      row.className = 'custom-row';
      row.innerHTML = `
        <input type="text" class="custom-name" placeholder="utm_custom" value="${name}" />
        <input type="text" class="custom-value" placeholder="значение" value="${value}" />
        <button type="button" aria-label="Удалить параметр">✕</button>
      `;

      row.querySelector('button').addEventListener('click', () => {
        row.remove();
        generateLink();
      });

      ['input', 'change'].forEach((eventName) => {
        row.querySelectorAll('input').forEach((input) => {
          input.addEventListener(eventName, () => {
            if (eventName === 'change') {
              input.value = slugify(input.value);
            }
            generateLink();
          });
        });
      });

      return row;
    };

    const getFormData = () => {
      const data = {
        baseUrl: baseUrlInput.value.trim(),
        params: {
          utm_source: slugify(document.getElementById('utm-source').value),
          utm_medium: slugify(document.getElementById('utm-medium').value),
          utm_campaign: slugify(document.getElementById('utm-campaign').value),
          utm_term: slugify(document.getElementById('utm-term').value),
          utm_content: slugify(document.getElementById('utm-content').value)
        },
        custom: []
      };

      customParamsContainer.querySelectorAll('.custom-row').forEach((row) => {
        const name = slugify(row.querySelector('.custom-name').value);
        const value = slugify(row.querySelector('.custom-value').value);
        if (name && value) {
          data.custom.push([name, value]);
        }
      });

      return data;
    };

    const buildUrl = () => {
      const { baseUrl, params, custom } = getFormData();
      if (!baseUrl) {
        baseUrlError.classList.remove('active');
        return '';
      }

      let url;
      try {
        url = new URL(baseUrl);
        baseUrlError.classList.remove('active');
      } catch (error) {
        baseUrlError.classList.add('active');
        return '';
      }

      const allParams = new URLSearchParams(url.search);
      Object.entries(params).forEach(([key, value]) => {
        if (value) {
          allParams.set(key, value);
        } else {
          allParams.delete(key);
        }
      });

      custom.forEach(([name, value]) => {
        allParams.set(name, value);
      });

      url.search = allParams.toString();
      return url.toString();
    };

    const generateLink = () => {
      const finalUrl = buildUrl();
      resultTextarea.value = finalUrl;
      return finalUrl;
    };

    addParamButton.addEventListener('click', () => {
      customParamsContainer.appendChild(createCustomRow());
    });

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const link = generateLink();
      if (link) {
        resultTextarea.focus();
        resultTextarea.select();
      }
    });

    form.querySelectorAll('input').forEach((input) => {
      input.addEventListener('input', () => {
        if (['utm-source', 'utm-medium', 'utm-campaign', 'utm-term', 'utm-content'].includes(input.id)) {
          const { selectionStart } = input;
          input.value = slugify(input.value);
          input.setSelectionRange(selectionStart, selectionStart);
        }
        generateLink();
      });

      input.addEventListener('change', () => {
        if (input.type !== 'url') {
          input.value = slugify(input.value);
        }
        generateLink();
      });
    });

    resetButton.addEventListener('click', () => {
      form.reset();
      customParamsContainer.innerHTML = '';
      resultTextarea.value = '';
      baseUrlError.classList.remove('active');
      baseUrlInput.focus();
    });

    copyButton.addEventListener('click', async () => {
      const link = generateLink();
      if (!link) {
        baseUrlInput.focus();
        return;
      }

      try {
        await navigator.clipboard.writeText(link);
        copyButton.textContent = 'Скопировано!';
        copyButton.disabled = true;
        setTimeout(() => {
          copyButton.textContent = 'Скопировать ссылку';
          copyButton.disabled = false;
        }, 1600);
      } catch (error) {
        copyButton.textContent = 'Не удалось скопировать';
        setTimeout(() => {
          copyButton.textContent = 'Скопировать ссылку';
        }, 1600);
      }
    });

    // Автогенерация при загрузке, если есть пример ссылки в адресной строке
    generateLink();
  </script>
</body>
</html>
